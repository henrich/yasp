#!/bin/bash
#
# yasp - Yet Another Simple/Speedy Piuparts
#
# 2013 Hideki Yamane <henrich@debian.or.jp>
# 
#-------------------------------------------------------------------------------

set -e

export LANG=C
export LC_ALL=C

if [ ! -z `grep Linux `uname -o`` ]; then
    echo "kernel: Linux"
elif [ ! -z `grep BSD `uname -o`` ]; then
    echo "kernel: *BSD"
    echo "it doesn't support aufs, aborting..."
    exit 1
else
    echo "kernel: unknown, aborting..."
    exit 1
fi

#FIXME: kFreeBSD support?
if [ -z `grep CONFIG_AUFS_FS "/boot/config-`uname -a| cut -d' ' -f3`"` ]; then
     echo "Your kernel seems to not support aufs, aborting..."
     exit 1
fi

#-------------------------------------------------------------------------------
# read configuration
#-------------------------------------------------------------------------------

for conf in /etc/yasp.conf ${HOME}/.yasp.conf
do
    if [ -f $conf ]; then
        . $conf
    fi
done

if [ -z "$yasp_dir" -o -z "$distro" -o -z "$mirror" ]; then
   echo "Something wrong with configuration... check your yasp.conf"
   exit 1
fi



case in "$1"
    init)

#-------------------------------------------------------------------------------
# prepare directories
#-------------------------------------------------------------------------------

for i in $distro
do
  if [ ! -d "$yasp_dir"/base/"$distro" ]; then
      mkdir -p "$yasp_dir"/base/"$distro"
  fi
  if [ ! -d "$yasp_dir"/aptcache/"$distro"/var/cache/apt/archives ]; then
      mkdir "$yasp_dir"/aptcache/"$distro"/var/cache/apt/archives
  fi
done

if [ ! -d "$yasp_dir"aptcache/host/var/cache/apt ]; then
   mkdir -p "$yasp_dir"aptcache/host/var/cache/apt
   (cd "$yasp_dir"aptcache/host/var/cache/apt; ln -s /var/cache/apt/arhicves archives)
fi

for dir in working mountdir failed
do
  if [ ! -d "$yasp_dir"/"$dir" ]; then
      mkdir "$yasp_dir"/"$dir"
  fi
done

#-------------------------------------------------------------------------------
# create base cow: use files if it exists, -P = base.tgz, -C = base.cow
#-------------------------------------------------------------------------------

if [ -d "$basecow" -o "$2" = -C ]; then
  basedistro=`cat /var/cache/pbuilder/base.cow/etc/apt/sources.list | head -n1 |cut -d' ' -f3`
  if [ ! -d "$yasp_dir"/base/"$basedistro" ]; then
      cp -arp "$basecow"/* "$yasp_dir"/base/"$basedistro"
  fi
elif [ -f "$basetgz" -o "$2" = -P ]; then
  basedistro=`cat `tar xvf "$basetgz" etc/apt/sources.list` |head -n1 |cut -d' ' -f3`
  if [ ! -d "$yasp_dir"/base/"$basedistro" ]; then
      tar -C "$yasp_dir"/base/"$basedistro" -xf "$basetgz" 
  fi
fi

base-update()
{
for i in $distro
do
  if [ -d "$yasp_dir"/base/"$distro"/etc ]; then
      chroot "$yasp_dir"/base/"$distro" apt-get -qq update
      chroot "$yasp_dir"/base/"$distro" apt-get -dyqq upgrade
  else
      debootstrap "$distro" "$yasp_dir"/base/"$distro" "$mirror"
  fi
done
}
    base-update()

    ;;
#-------------------------------------------------------------------------------

    base-update)

    base-update()
    ;;
#-------------------------------------------------------------------------------

    test)

# get package name from changes file, e.g. hail_0.8+0.11.37389dbf9b-1_amd64.changes
#FIXME: now yasp can only accept .changes file, however probably user want to test .debs

packagefile=`echo $2|grep .changes$`

if [ -z "$packagefile" ]; then
    echo "Please specify .changes file"
    exit 1
else
    package=`cat $packagefile | cut -d' ' -f4|grep .deb$|sort|uniq|cut -d'_' -f1`
fi

# cache *.deb to aptcache

for i in $distro
do
    chroot "$yasp_dir"/base/"$distro" apt-get -qq update
    if [ ! -z "$package" ]; then
      for i in $package
      do
          tmpmountdir=`mktemp -d --tmpdir "$yasp_dir"/mountdir --suffix="`date +%Y%m%d%H%M%S`"`
          mount -t aufs br="$yasp_dir"/aptcache/"$distro":"$yasp_dir"/base/"$distro"=ro:"$yasp_dir"/aptcache/host=ro none "$yasp_dir"/mountdir/"$tmpmountdir"
          pkgcheck=`chroot "$yasp_dir"/base/"$distro" apt-cache show -q "$i"`
          if [ ! "$pkgcheck" = "E: No packages found" ]; then
              chroot "$yasp_dir"/working/"$tmpdir" apt-get -dyqq install "$i"
          fi
          umount "$yasp_dir"/mountdir/"$tmpmountdir" && rmdir "$yasp_dir"/mountdir/"$tmpmountdir"
      done
    fi
done

packagelist=`cat "$packagefile" |cut -d' ' -f4|grep .deb$|sort|uniq`
for i in $distro
do
        cp -f "$packagelist" "$yasp_dir"/aptcache/"$distro"/var/cache/apt/archives/
	workdir=`mktemp -d --tmpdir "$yasp_dir"/working --suffix="$distro"_"$packagefile"_"`date +%Y%m%d%H%M%S`"`
        tmpmountdir=`mktemp -d --tmpdir "$yasp_dir"/mountdir --suffix="`date +%Y%m%d%H%M%S`"`
        mount -t aufs br="$yasp_dir"/working/"$workdir":"$yasp_dir"/aptcache/"$distro"=ro:"$yasp_dir"/base/"$distro"=ro:"$yasp_dir"/aptcache/host=ro none "$yasp_dir"/mountdir/"$tmpmountdir"
	mount --bind /proc "$yasp_dir"/mountdir/"$tmpmountdir"/proc
	mount --bind /dev/pts "$yasp_dir"/mountdir/"$tmpmountdir"/dev/pts
	# inside chroot
	chroot "$yasp_dir"/mountdir/"$tmpmountdir"
	cd /var/cache/apt/archives/; dpkg -i "$packagelist"
	apt-get -fy install
	exit
	# throw chroot away...
	umount "$yasp_dir"/mountdir/"$tmpmountdir"/proc
	umount "$yasp_dir"/mountdir/"$tmpmountdir"/dev/pts
	umount "$yasp_dir"/mountdir/"$tmpmountdir"
done
    ;;
#-------------------------------------------------------------------------------

    help | *)
    echo <<EOL
init 
base-update
test
help
EOL

    ;;
esac

